# 9×9 Futoshiki Sudoku (Rust + WASM)

## 1. 목표

- **9×9 스도쿠 규칙** + **부등호(Futoshiki) 제약** 퍼즐 생성
- **항상 해가 존재**하며 **유일해(unique solution)** 보장
- **웹 게임**에 탑재 가능 (Rust + WASM)
- 플레이어는 **난이도 선택 가능**

---

## 2. 퍼즐 정의 (중요)

### 2.1 항상 주어지는 정보 (고정 전제)

- 각 cell에는 숫자 1~9 중 하나가 들어간다
- **모든 cell 내부에는 숫자 1~9에 대한 완전한 부등호 정보가 주어진다**
  - 즉, 각 cell 안에서는 9개의 숫자 사이의 상대적 순서가 모두 명시됨
- 이 정보는 **항상 제공되며**, 난이도 및 생성 알고리즘의 고려 대상이 아니다

> 해석 관점:
> - 각 cell의 값은 1~9 중 하나
> - cell 내부 부등호는 곧 **숫자의 rank 체계가 고정됨**을 의미

---

### 2.2 선택적으로 주어지는 정보 (난이도 요소)

- **서로 다른 cell 간의 숫자 비교 부등호**
  - 예: cell A의 값 < cell B의 값
- 이는 기존 후토시키의 핵심 제약이며
- **이 정보의 양이 많을수록 퍼즐은 쉬워진다**

> 본 설계의 핵심 원칙:
> **cell 간 정보 ↓ → 난이도 ↑**

---

## 3. 문제 성격 요약

- 퍼즐 풀기: NP-hard
- 유일해 판정: coNP-hard
- 하지만
  - 크기 고정 (9×9)
  - cell 내부 순서 정보는 항상 주어짐

→ 실전적으로 매우 안정적인 CSP 구성 가능

---

## 4. 전체 생성 파이프라인

```
[1] 완전한 스도쿠 해 생성
        ↓
[2] cell 간 inequality 후보 전체 생성 (정답 기반)
        ↓
[3] 난이도에 따라 일부 inequality만 선택
        ↓
[4] CSP Solver로 유일해 검사
        ↓
[5] 실패 시 [3] 또는 [2] 재시도
```

---

## 5. Step 1. 완전한 스도쿠 해 생성

### 요구사항
- 9×9
- 행 / 열 / 3×3 블록 제약 만족
- 충분한 랜덤성

### 구현 방법
- Randomized Backtracking
- 또는 DLX (선택)

### 출력
- `solution[81]`: 1~9 정수 배열

---

## 6. Step 2. cell 간 inequality 후보 생성

### 기본 원칙 (절대 규칙)

```text
if solution[a] > solution[b]:
    a > b 가능
else:
    b > a 가능
```

- 정답을 위배하는 inequality는 절대 생성하지 않음

### 후보 위치
- 인접 cell만 사용 (가독성 & 안정성)
  - 상 / 하 / 좌 / 우
- 총 후보 수: 최대 약 144개

### 자료구조 예시

```rust
struct Inequality {
    a: usize,
    b: usize,
    dir: i8, // 1: a>b, -1: a<b
}
```

---

## 7. Step 3. 난이도 설계 (핵심 변경점)

### 기본 원칙

> **cell 간 inequality 정보가 많을수록 퍼즐은 쉬워진다**

난이도는 **cell 간 부등호의 개수 및 구조**로만 조절한다.

---

### Easy

- inequality 수: 많음 (30~50)
- 대부분 행/열 내부
- 긴 체인 허용

효과:
- 강한 제약 전파
- 백트래킹 거의 없음
- 초보자용

---

### Normal

- inequality 수: 중간 (20~30)
- 행/열 + 일부 블록 경계
- 중간 길이 체인

효과:
- 논리 추론 위주
- 제한적 탐색 필요

---

### Hard

- inequality 수: 적음 (10~20)
- 블록 간 연결 위주
- 체인 짧음

효과:
- 정보 부족
- 추론 난이도 상승

---

### Expert

- inequality 수: 매우 적음 (5~10)
- 정보 효율 높은 위치만 선택
- 대부분 독립적인 비교

효과:
- 탐색 공간 큼
- 인간 체감 난이도 매우 높음

---

## 8. Step 4. CSP Solver 설계

### 변수
- 81개 cell
- 도메인: {1..9}

### 제약
1. 행 중복 금지
2. 열 중복 금지
3. 3×3 블록 중복 금지
4. cell 간 inequality 제약

> cell 내부 부등호는 항상 주어지므로 solver 외부 전제로 처리

---

## 9. Solver 핵심 기법

### (1) 비트마스크 도메인
- 9비트 mask 사용

### (2) 제약 전파
- Naked single
- 행 / 열 / 블록 제거
- inequality min/max pruning

### (3) 탐색 전략
- MRV (Minimum Remaining Values)
- 해 2개 발견 시 즉시 중단

---

## 10. 유일해 판정 기준

- solver 결과:
  - 0개 → discard
  - 1개 → 채택
  - ≥2개 → discard

> 계산적 증명으로 유일해 보장

---

## 11. 성능 관리 전략

- inequality가 적을수록 탐색 비용 증가
- Expert 난이도는 생성 실패 가능성 높음

### 권장 구조
- 퍼즐 생성: WebWorker 또는 서버
- 퍼즐 풀이: 메인 스레드 WASM

---

## 12. Rust 모듈 구성

```
src/
 ├─ sudoku.rs        // 스도쿠 해 생성
 ├─ futoshiki.rs     // inequality 구조
 ├─ solver.rs        // CSP solver
 ├─ generator.rs    // 퍼즐 생성 파이프라인
 └─ lib.rs           // wasm-bindgen 인터페이스
```

---

## 13. WASM 인터페이스

### 입력
- 난이도 (enum: Easy / Normal / Hard / Expert)

### 출력 (JSON)

```json
{
  "grid": [-1, -1, ...],
  "inequalities": [{"a":0,"b":1,"dir":1}],
  "solution": [5,3,4,...]
}
```

---

## 14. 리스크 & 대응

| 리스크 | 대응 |
|------|------|
| Expert 생성 실패 | inequality 후보 재선택 |
| 너무 쉬움 | inequality 감소 |
| 너무 어려움 | inequality 증가 |
| 생성 지연 | 난이도별 시도 횟수 제한 |

---

## 15. 결론

- cell 내부 부등호는 항상 제공
- **난이도는 오직 cell 간 부등호 정보의 부족함에서 발생**
- 생성 알고리즘은 단순하지만
  - 난이도 조절은 매우 정밀하게 가능

> 이 퍼즐의 본질은
> **"얼마나 적은 비교 정보로 정답을 추론해야 하는가"**이다

